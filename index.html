<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fit Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .progress-fill { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-24">

    <div class="max-w-md mx-auto p-4 space-y-4">
        <header class="text-center py-4">
            <h1 class="text-3xl font-extrabold text-green-600">Mifa Fit Pro</h1>
            <p id="currentDate" class="text-gray-500 font-medium text-sm"></p>
        </header>

        <div class="bg-white rounded-3xl shadow-sm p-5 border border-gray-100">
            <div class="flex justify-between items-end mb-2">
                <h2 class="text-gray-700 font-bold">ä»Šæ—¥ç†±é‡ç›®æ¨™</h2>
                <span id="kcalPercent" class="text-xs font-bold text-green-600">0%</span>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-3 mb-2">
                <div id="kcalBar" class="bg-green-500 h-3 rounded-full progress-fill" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-[10px] text-gray-400">
                <p id="tdeeGoalText">æ­£åœ¨è¨ˆç®—...</p>
                <p id="kcalText">0 / 0 kcal</p>
            </div>
            
            <div class="grid grid-cols-3 gap-2 mt-4">
                <div class="bg-blue-50 p-2 rounded-2xl text-center border border-blue-100">
                    <p class="text-[10px] text-blue-400 font-bold">è›‹ç™½è³ª</p>
                    <p id="totalPro" class="text-sm font-black text-blue-700">0g</p>
                </div>
                <div class="bg-yellow-50 p-2 rounded-2xl text-center border border-yellow-100">
                    <p class="text-[10px] text-yellow-600 font-bold">ç¢³æ°´</p>
                    <p id="totalCarb" class="text-sm font-black text-yellow-800">0g</p>
                </div>
                <div class="bg-red-50 p-2 rounded-2xl text-center border border-red-100">
                    <p class="text-[10px] text-red-400 font-bold">è„‚è‚ª</p>
                    <p id="totalFat" class="text-sm font-black text-red-700">0g</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm p-5 border border-blue-50">
            <div class="flex justify-between items-center mb-3">
                <h2 class="font-bold text-blue-600 flex items-center gap-1">ğŸ’§ é£²æ°´è¿½è¹¤</h2>
                <span id="waterText" class="text-xs font-bold text-blue-500">0 / 2000 cc</span>
            </div>
            <div class="w-full bg-blue-50 rounded-full h-2 mb-4">
                <div id="waterBar" class="bg-blue-400 h-2 rounded-full progress-fill" style="width: 0%"></div>
            </div>
            <div class="flex gap-2">
                <button onclick="addWater(300)" class="flex-1 bg-blue-500 text-white py-2 rounded-xl font-bold shadow-sm active:scale-95 transition text-sm">+ 300cc</button>
                <button onclick="addWater(500)" class="flex-1 bg-blue-600 text-white py-2 rounded-xl font-bold shadow-sm active:scale-95 transition text-sm">+ 500cc</button>
                <button onclick="resetWater()" class="bg-gray-100 text-gray-400 px-3 rounded-xl text-xs">é‡ç½®</button>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm p-5 border border-gray-100">
            <h2 class="font-bold mb-3 text-sm">ğŸ¥— è¨˜éŒ„é£²é£Ÿ</h2>
            <div class="flex gap-2">
                <input type="text" id="foodInput" placeholder="è¼¸å…¥é£Ÿæ (ä¸­æ–‡å¯)" class="flex-1 border border-gray-100 p-2 rounded-xl text-sm outline-none focus:border-green-400">
                <button onclick="handleSearch()" class="bg-green-500 text-white px-4 py-2 rounded-xl font-bold text-sm">æœå°‹</button>
            </div>
            <p id="translateStatus" class="text-[10px] text-blue-400 mt-1 hidden"></p>
            <div id="searchResult" class="hidden mt-3 bg-gray-50 p-3 rounded-2xl flex justify-between items-center border border-dashed border-gray-200">
                <div>
                    <p id="resName" class="text-sm font-bold text-gray-700"></p>
                    <p id="resInfo" class="text-[10px] text-gray-400"></p>
                </div>
                <button onclick="addToDiary()" class="bg-blue-500 text-white px-4 py-1 rounded-full text-xs font-bold">+ åŠ å…¥</button>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm p-5 border border-gray-100">
            <h2 class="font-bold mb-3 text-sm">âš–ï¸ é«”é‡è¨˜éŒ„</h2>
            <div class="flex gap-2 mb-4">
                <input type="number" id="weightInput" step="0.1" placeholder="kg" class="flex-1 border border-gray-100 p-2 rounded-xl text-sm outline-none">
                <button onclick="saveWeight()" class="bg-orange-400 text-white px-6 py-2 rounded-xl font-bold text-sm">å„²å­˜</button>
            </div>
            <canvas id="weightChart" height="150"></canvas>
        </div>

        <div class="bg-white rounded-3xl shadow-sm p-5 border border-gray-100">
            <button onclick="toggleHistory()" class="w-full flex justify-between items-center font-bold text-sm text-gray-600">
                <span>ğŸ“… æ­·å²ç´€éŒ„ (7å¤©)</span>
                <span id="historyArrow">â–¼</span>
            </button>
            <div id="historyList" class="hidden mt-4 space-y-2 text-xs text-gray-500"></div>
        </div>
        
        <p class="text-[10px] text-center text-gray-300">è³‡æ–™å„²å­˜æ–¼æœ¬åœ°ç€è¦½å™¨</p>
    </div>

    <script>
        const APP_ID = '3b185717';
        const APP_KEY = '023d04b5d811e3b080c6e899752092b8';
        const MY_HEIGHT = 167;
        const MY_AGE = 31;
        
        let todayStr = new Date().toLocaleDateString();
        let diary = JSON.parse(localStorage.getItem('mifa_diary')) || { kcal:0, pro:0, carb:0, fat:0, water:0, date: todayStr };
        let weightHistory = JSON.parse(localStorage.getItem('mifa_weight')) || [];
        let diaryHistory = JSON.parse(localStorage.getItem('mifa_diary_history')) || [];
        let tempFood = null, weightChart;

        document.getElementById('currentDate').innerText = todayStr;

        window.onload = () => {
            if(diary.date !== todayStr) {
                diaryHistory.push({...diary});
                if(diaryHistory.length > 7) diaryHistory.shift();
                localStorage.setItem('mifa_diary_history', JSON.stringify(diaryHistory));
                resetTodayData();
            }
            updateUI();
            updateCharts();
            renderHistory();
        };

        function updateUI() {
            const lastWeight = weightHistory.length > 0 ? weightHistory[weightHistory.length-1].val : 60;
            const bmr = (10 * lastWeight) + (6.25 * MY_HEIGHT) - (5 * MY_AGE) - 161;
            const tdee = Math.round(bmr * 1.2); 
            const targetKcal = tdee - 350;
            const targetWater = Math.round(lastWeight * 35); // å»ºè­°æ°´é‡ = é«”é‡ x 35cc

            // æ›´æ–°ç†±é‡é€²åº¦
            const kcalPercent = Math.min(Math.round((diary.kcal / targetKcal) * 100), 100);
            document.getElementById('kcalBar').style.width = kcalPercent + '%';
            document.getElementById('kcalPercent').innerText = kcalPercent + '%';
            document.getElementById('kcalText').innerText = `${Math.round(diary.kcal)} / ${targetKcal} kcal`;
            document.getElementById('tdeeGoalText').innerText = `TDEE: ${tdee} | ç›®æ¨™: ${targetKcal}`;

            // æ›´æ–°ç‡Ÿé¤Šç´ 
            document.getElementById('totalPro').innerText = diary.pro.toFixed(1) + 'g';
            document.getElementById('totalCarb').innerText = diary.carb.toFixed(1) + 'g';
            document.getElementById('totalFat').innerText = diary.fat.toFixed(1) + 'g';

            // æ›´æ–°é£²æ°´é€²åº¦
            const waterPercent = Math.min(Math.round((diary.water / targetWater) * 100), 100);
            document.getElementById('waterBar').style.width = waterPercent + '%';
            document.getElementById('waterText').innerText = `${diary.water} / ${targetWater} cc`;
        }

        async function handleSearch() {
            const raw = document.getElementById('foodInput').value;
            if(!raw) return;
            const status = document.getElementById('translateStatus');
            status.classList.remove('hidden'); status.innerText = "ğŸ” æœå°‹ä¸­...";
            
            let query = raw;
            if (!/^[a-zA-Z\s]+$/.test(raw)) {
                try {
                    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURIComponent(raw)}`);
                    const data = await res.json();
                    query = data[0][0][0];
                } catch(e) { console.error("ç¿»è­¯å¤±æ•—"); }
            }
            
            try {
                const resFood = await fetch(`https://api.edamam.com/api/food-database/v2/parser?app_id=${APP_ID}&app_key=${APP_KEY}&ingr=${query}&nutrition-type=logging`);
                const foodData = await resFood.json();
                if(foodData.hints[0]) {
                    tempFood = foodData.hints[0].food.nutrients;
                    document.getElementById('searchResult').classList.remove('hidden');
                    document.getElementById('resName').innerText = foodData.hints[0].food.label;
                    document.getElementById('resInfo').innerText = `${Math.round(tempFood.ENERC_KCAL)} kcal / 100g`;
                }
            } catch(e) { alert("æœå°‹å¤±æ•—"); }
            status.classList.add('hidden');
        }

        function addToDiary() {
            diary.kcal += tempFood.ENERC_KCAL;
            diary.pro += tempFood.PROCNT;
            diary.carb += tempFood.CHOCDF;
            diary.fat += tempFood.FAT;
            saveDiary();
            document.getElementById('searchResult').classList.add('hidden');
            document.getElementById('foodInput').value = '';
        }

        function addWater(amount) {
            diary.water += amount;
            saveDiary();
        }

        function resetWater() {
            if(confirm("ç¢ºå®šè¦é‡ç½®ä»Šæ—¥é£²æ°´é‡å—ï¼Ÿ")) {
                diary.water = 0;
                saveDiary();
            }
        }

        function saveDiary() {
            localStorage.setItem('mifa_diary', JSON.stringify(diary));
            updateUI();
        }

        function saveWeight() {
            const val = document.getElementById('weightInput').value;
            if(!val) return;
            weightHistory.push({ date: new Date().toLocaleDateString().slice(5), val: parseFloat(val) });
            localStorage.setItem('mifa_weight', JSON.stringify(weightHistory));
            updateCharts();
            updateUI();
            alert("é«”é‡å·²è¨˜éŒ„");
        }

        function toggleHistory() {
            const list = document.getElementById('historyList');
            const arrow = document.getElementById('historyArrow');
            list.classList.toggle('hidden');
            arrow.innerText = list.classList.contains('hidden') ? "â–¼" : "â–²";
        }

        function renderHistory() {
            document.getElementById('historyList').innerHTML = diaryHistory.map(h => `
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                    <span>${h.date}</span>
                    <span class="font-bold text-gray-700">${Math.round(h.kcal)} kcal</span>
                    <span class="text-blue-400">${h.water} cc</span>
                </div>
            `).join('') || "å°šç„¡æ­·å²ç´€éŒ„";
        }

        function updateCharts() {
            if(weightChart) weightChart.destroy();
            const ctx = document.getElementById('weightChart').getContext('2d');
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weightHistory.map(h => h.date).slice(-7),
                    datasets: [{ 
                        label: 'é«”é‡ (kg)', 
                        data: weightHistory.map(h => h.val).slice(-7), 
                        borderColor: '#fb923c', 
                        backgroundColor: '#fb923c22',
                        fill: true,
                        tension: 0.4 
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });
        }

        function resetTodayData() {
            diary = { kcal:0, pro:0, carb:0, fat:0, water:0, date: todayStr };
            saveDiary();
        }

        function clearToday() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤ä»Šæ—¥æ‰€æœ‰æ•¸æ“šå—ï¼Ÿ")) resetTodayData();
        }
    </script>
</body>
</html>
